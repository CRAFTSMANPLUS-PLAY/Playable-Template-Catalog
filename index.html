<script>
  const DATA_URL = "Playable_Endpoint_URLs.json";
  const FALLBACK_THUMB = "placeholder.png"; // <-- optional, create/upload this; otherwise we just hide

  async function loadCatalogue() {
    try {
      const res = await fetch(DATA_URL, { cache: "no-store" });
      const raw = await res.json();

      const items = (Array.isArray(raw) ? raw : []).map((row) => {
        const title = row["Title"] || "Untitled";
        const genre =
          row["Genre"] && String(row["Genre"]).trim()
            ? String(row["Genre"]).trim()
            : "Other";

        // this is the one that should open in a new tab
        const previewUrl = row["URL"] || row["Preview URL"] || "";

        // this is the one that actually RUNS the playable in the card
        const endpointUrl = row["Endpoint URL"] || previewUrl || "";

        const hasAdvanced = !!row["Complex / Advanced Option"];
        const isBanner = row["Unnamed: 5"]
          ? String(row["Unnamed: 5"]).toLowerCase().includes("banner")
          : false;

        const slug = title
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-|-$/g, "");

        return {
          title,
          genre,
          endpointUrl,
          previewUrl,
          hasAdvanced,
          isBanner,
          thumbnail: slug + ".png",
        };
      });

      renderCatalogue(items);
    } catch (err) {
      console.error("Failed to load JSON, using empty list.", err);
      renderCatalogue([]);
    }
  }

  function groupByGenre(list) {
    const out = {};
    list.forEach((item) => {
      const g = item.genre || "Other";
      if (!out[g]) out[g] = [];
      out[g].push(item);
    });
    return out;
  }

  function renderCatalogue(allItems) {
    const app = document.getElementById("app");
    app.innerHTML = "";

    const playables = allItems.filter((x) => !x.isBanner);
    const banners = allItems.filter((x) => x.isBanner);

    // PLAYABLES
    const playableSection = document.createElement("section");
    const playableHeader = document.createElement("div");
    playableHeader.className = "section-title";
    playableHeader.textContent = "PLAYABLES";
    playableSection.appendChild(playableHeader);

    if (playables.length === 0) {
      const empty = document.createElement("div");
      empty.className = "empty-state";
      empty.textContent = "No playables found in JSON.";
      playableSection.appendChild(empty);
    } else {
      const playableByGenre = groupByGenre(playables);
      Object.entries(playableByGenre).forEach(([genre, list]) => {
        const gBlock = document.createElement("div");
        gBlock.className = "genre-block";

        const gHeader = document.createElement("div");
        gHeader.className = "genre-header";
        const gName = document.createElement("div");
        gName.className = "genre-name";
        gName.textContent = genre;
        const gCount = document.createElement("div");
        gCount.className = "genre-count";
        gCount.textContent = list.length + " demos";
        gHeader.appendChild(gName);
        gHeader.appendChild(gCount);
        gBlock.appendChild(gHeader);

        const grid = document.createElement("div");
        grid.className = "grid";

        list.forEach((item) => {
          grid.appendChild(createCard(item));
        });

        gBlock.appendChild(grid);
        playableSection.appendChild(gBlock);
      });
    }

    app.appendChild(playableSection);

    // BANNERS (if any)
    if (banners.length > 0) {
      const bannerSection = document.createElement("section");
      const bannerHeader = document.createElement("div");
      bannerHeader.className = "section-title";
      bannerHeader.textContent = "ANIMATED BANNERS";
      bannerSection.appendChild(bannerHeader);

      const bannerByGenre = groupByGenre(banners);
      Object.entries(bannerByGenre).forEach(([genre, list]) => {
        const gBlock = document.createElement("div");
        gBlock.className = "genre-block";

        const gHeader = document.createElement("div");
        gHeader.className = "genre-header";
        const gName = document.createElement("div");
        gName.className = "genre-name";
        gName.textContent = genre;
        const gCount = document.createElement("div");
        gCount.className = "genre-count";
        gCount.textContent = list.length + " banners";
        gHeader.appendChild(gName);
        gHeader.appendChild(gCount);
        gBlock.appendChild(gHeader);

        const grid = document.createElement("div");
        grid.className = "grid";

        list.forEach((item) => {
          grid.appendChild(createCard(item));
        });

        gBlock.appendChild(grid);
        bannerSection.appendChild(gBlock);
      });

      app.appendChild(bannerSection);
    }
  }

  function createCard(item) {
    const card = document.createElement("article");
    card.className = "card";

    const top = document.createElement("div");
    top.className = "card-top";

    const metaWrap = document.createElement("div");
    const titleEl = document.createElement("div");
    titleEl.className = "card-title";
    titleEl.textContent = item.title || "Untitled";

    const genreEl = document.createElement("div");
    genreEl.className = "card-genre";
    genreEl.textContent = item.genre || "Other";

    metaWrap.appendChild(titleEl);
    metaWrap.appendChild(genreEl);

    if (item.hasAdvanced) {
      const adv = document.createElement("div");
      adv.className = "badge-advanced";
      adv.innerHTML = "<span>âœ”</span><span>Advanced Options / Variants</span>";
      metaWrap.appendChild(adv);
    }

    const actions = document.createElement("div");
    actions.className = "card-actions";

    // â†— open PLAY URL (preferred) or endpoint as fallback
    const btnExternal = document.createElement("button");
    btnExternal.className = "icon-btn";
    btnExternal.title = "Open PLAY preview in new tab";
    btnExternal.textContent = "â†—";
    btnExternal.addEventListener("click", (e) => {
      e.stopPropagation();
      const targetUrl = item.previewUrl || item.endpointUrl;
      if (targetUrl) window.open(targetUrl, "_blank");
    });
    actions.appendChild(btnExternal);

    // ðŸ”„ reset
    const btnReset = document.createElement("button");
    btnReset.className = "icon-btn";
    btnReset.title = "Reset playable";
    btnReset.textContent = "ðŸ”„";
    // we'll attach handler later once iframe/thumbnail exist
    actions.appendChild(btnReset);

    top.appendChild(metaWrap);
    top.appendChild(actions);
    card.appendChild(top);

    // THUMB / IFRAME
    const thumbWrap = document.createElement("div");
    thumbWrap.className = "thumb-wrap";

    const thumbImg = document.createElement("img");
    thumbImg.src = item.thumbnail || "";
    thumbImg.alt = item.title || "Playable thumbnail";

    // fallback if image 404s
    thumbImg.addEventListener("error", () => {
      if (FALLBACK_THUMB) {
        thumbImg.src = FALLBACK_THUMB;
      } else {
        thumbImg.style.display = "none";
      }
    });

    thumbWrap.appendChild(thumbImg);

    const overlay = document.createElement("div");
    overlay.className = "play-overlay";
    const playBtn = document.createElement("button");
    playBtn.className = "play-now-btn";
    playBtn.type = "button";
    playBtn.textContent = "PLAY NOW â–¶";
    overlay.appendChild(playBtn);
    thumbWrap.appendChild(overlay);

    const iframe = document.createElement("iframe");
    iframe.className = "iframe-holder";
    iframe.allow =
      "accelerometer; autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture;";
    iframe.loading = "lazy";
    iframe.title = item.title || "Playable";
    iframe.style.display = "none";

    // load function with loading state
    const loadIframe = () => {
      if (!item.endpointUrl) return;
      // set loading state
      playBtn.textContent = "Loadingâ€¦";
      playBtn.disabled = true;

      iframe.src = item.endpointUrl;
      iframe.style.display = "block";
      thumbWrap.style.display = "none";
    };

    // when iframe finishes -> restore button
    iframe.addEventListener("load", () => {
      playBtn.textContent = "PLAY NOW â–¶";
      playBtn.disabled = false;
    });

    thumbWrap.addEventListener("click", (e) => {
      e.stopPropagation();
      loadIframe();
    });

    playBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      loadIframe();
    });

    card.appendChild(thumbWrap);
    card.appendChild(iframe);

    // now wire up reset (needs access to iframe + thumb)
    btnReset.addEventListener("click", (e) => {
      e.stopPropagation();
      iframe.src = "";
      iframe.style.display = "none";
      thumbWrap.style.display = "flex";
      // restore button UI
      playBtn.textContent = "PLAY NOW â–¶";
      playBtn.disabled = false;
    });

    // FOOTER
    const footer = document.createElement("div");
    footer.className = "card-footer";
    footer.textContent =
      item.previewUrl || item.endpointUrl || "(no URL provided)";
    card.appendChild(footer);

    return card;
  }

  loadCatalogue();
</script>
